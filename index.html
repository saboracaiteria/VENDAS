<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Busca de Itens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adicionada a biblioteca jsPDF para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        input[type=search]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 1.5em;
            width: 1.5em;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239CA3AF'><path d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/></svg>");
            background-repeat: no-repeat;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-300">

    <!-- Tela de Senha -->
    <div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-800">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4">Acesso Restrito</h2>
            <p class="text-gray-600 mb-6">Por favor, digite a senha para continuar.</p>
            <input type="password" id="password-input" class="w-full p-3 border-2 border-gray-300 rounded-md text-center text-lg tracking-widest focus:outline-none focus:ring-2 focus:ring-gray-400" placeholder="••••" autofocus>
            <p id="password-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <button id="password-submit" class="w-full bg-black text-white py-3 rounded-md font-semibold mt-4 hover:bg-gray-700 transition-colors">Entrar</button>
        </div>
    </div>

    <!-- Container Principal do App (escondido inicialmente) -->
    <div id="app-container" class="max-w-lg mx-auto bg-gray-100 shadow-lg min-h-screen hidden">
        <header class="bg-black text-white p-4 flex items-center shadow-md sticky top-0 z-10">
            <h1 class="text-lg font-semibold uppercase mx-auto tracking-wider">Busca de Itens</h1>
        </header>

        <div class="p-4 bg-white border-b border-gray-200">
            <div class="relative flex items-center">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396l1.414-1.414l-4.396-4.396A7.952 7.952 0 0 0 18 10c0-4.411-3.589-8-8-8s-8 3.589-8 8s3.589 8 8 8zm0-14c3.309 0 6 2.691 6 6s-2.691 6-6 6s-6-2.691-6-6s2.691-6 6-6z"/></svg>
                </span>
                <input type="search" id="search-input" placeholder="Nome item ou use a voz..." class="w-full pl-10 pr-12 py-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-400">
                <button id="voice-search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 14a2 2 0 0 0 2-2V6a2 2 0 0 0-4 0v6a2 2 0 0 0 2 2zm-2-8a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2V6zm10 4a1 1 0 0 0-1 1a7 7 0 0 1-14 0a1 1 0 0 0-2 0a9 9 0 0 0 8 8.94V22a1 1 0 0 0 2 0v-2.06A9 9 0 0 0 20 11a1 1 0 0 0-1-1z"/></svg>
                </button>
            </div>
        </div>
        
        <div class="flex-grow p-4">
            <div id="cart-section">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">MEU PEDIDO</h2>
                <div id="cart-items" class="space-y-2">
                    <p class="text-gray-500">Seu pedido está vazio.</p>
                </div>
                
                <div class="totals-section mt-4 pt-4 border-t">
                     <div class="flex justify-between items-center mb-2">
                         <label for="discount-input" class="text-gray-600">Desconto (R$):</label>
                         <input type="number" id="discount-input" placeholder="0.00" class="w-24 text-right border rounded-md p-1">
                     </div>
                    <div id="cart-total" class="flex justify-between items-center font-bold text-xl">
                        <span>Total:</span>
                        <strong id="total-value">R$ 0,00</strong>
                    </div>
                </div>

                <div class="whatsapp-section mt-4">
                    <!-- Novo campo para nome do cliente -->
                    <input type="text" id="client-name" placeholder="Nome do cliente" class="w-full p-2 border rounded-md mb-2">
                    <input type="tel" id="whatsapp-number" placeholder="DDD + Número do cliente" class="w-full p-2 border rounded-md mb-2">
                    <button id="whatsapp-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition-colors">Enviar Orçamento</button>
                    <button id="copy-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-md mt-2 hover:bg-gray-600 transition-colors">Copiar Orçamento</button>
                    <button id="pdf-btn" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded-md mt-2 hover:bg-red-600 transition-colors">Gerar PDF do Orçamento</button>
                    <button id="clear-cart-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-md mt-2 hover:bg-orange-600 transition-colors">Limpar Pedido</button>
                </div>
            </div>
            
            <div id="search-results-section" class="mt-6">
                <h2 class="text-lg font-semibold mb-2 text-gray-700 border-t pt-4">RESULTADOS DA BUSCA</h2>
                <div id="product-list" class="space-y-2">
                     <p id="initial-message" class="text-center text-gray-500 py-4">Digite para buscar...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="add-item-modal" class="fixed inset-0 z-50 items-center justify-center flex hidden bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm">
            <div class="bg-gray-200 p-3 rounded-t-lg">
                <h3 id="modal-item-name" class="font-bold text-center text-gray-700"></h3>
            </div>
            <div class="p-4 space-y-3 text-sm">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-500">FABRICANTE:</span>
                    <span id="modal-item-manufacturer" class="text-right font-semibold text-gray-800"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-500">QUANTIDADE:</span>
                    <div class="flex items-center space-x-3">
                        <button id="modal-qty-minus" class="w-8 h-8 rounded-full border bg-gray-200 font-bold text-lg">-</button>
                        <input type="number" id="modal-qty" value="1" class="font-bold text-lg w-12 text-center border rounded-md">
                        <button id="modal-qty-plus" class="w-8 h-8 rounded-full border bg-green-500 text-white font-bold text-lg">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-500">VALOR:</span>
                    <input type="number" id="modal-item-price" class="w-24 text-right border rounded-md p-1 font-semibold text-green-600" step="0.01">
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-500">DESCONTO (%):</span>
                    <input type="number" id="modal-item-discount" class="w-24 text-right border rounded-md p-1" placeholder="0">
                </div>
                <div class="flex justify-between items-center font-bold text-lg border-t pt-2">
                    <span class="text-gray-600">VALOR TOTAL:</span>
                    <span id="modal-total-price" class="text-black"></span>
                </div>
            </div>
            <div class="p-2 flex flex-col space-y-2">
                <button id="modal-add-btn" class="bg-black text-white py-3 rounded-md font-semibold hover:bg-gray-800 transition-colors">ADICIONAR</button>
                <button id="modal-cancel-btn" class="bg-gray-400 text-black py-3 rounded-md font-semibold hover:bg-gray-500 transition-colors">CANCELAR</button>
            </div>
        </div>
    </div>
    
    <textarea id="quote-text" class="absolute -left-full"></textarea>
    <div id="message-box" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-4 rounded-md shadow-lg transition-opacity duration-300 opacity-0"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const passwordError = document.getElementById('password-error');
            const appContainer = document.getElementById('app-container');
            const searchInput = document.getElementById('search-input');
            const voiceSearchBtn = document.getElementById('voice-search-btn'); // Botão de busca por voz
            const productListElement = document.getElementById('product-list');
            const cartItemsElement = document.getElementById('cart-items');
            const totalValueElement = document.getElementById('total-value');
            const discountInput = document.getElementById('discount-input');
            const clientNameInput = document.getElementById('client-name'); // Referência para o novo campo
            const whatsappNumberInput = document.getElementById('whatsapp-number');
            const whatsappBtn = document.getElementById('whatsapp-btn');
            const copyBtn = document.getElementById('copy-btn');
            const pdfBtn = document.getElementById('pdf-btn'); 
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const messageBox = document.getElementById('message-box');
            const modal = document.getElementById('add-item-modal');
            const modalItemName = document.getElementById('modal-item-name');
            const modalItemManufacturer = document.getElementById('modal-item-manufacturer');
            const modalQtyInput = document.getElementById('modal-qty');
            const modalQtyMinus = document.getElementById('modal-qty-minus');
            const modalQtyPlus = document.getElementById('modal-qty-plus');
            const modalItemPrice = document.getElementById('modal-item-price');
            const modalItemDiscount = document.getElementById('modal-item-discount');
            const modalTotalPrice = document.getElementById('modal-total-price');
            const modalAddBtn = document.getElementById('modal-add-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            let allProducts = [];
            let cart = [];
            let currentModalProduct = null;
            let currentEditIndex = null;
            let globalDiscount = 0;
            
            // --- Persistência de Dados ---
            const saveStateToLocalStorage = () => {
                const state = {
                    cart: cart,
                    globalDiscount: globalDiscount,
                    clientName: clientNameInput.value,
                    whatsappNumber: whatsappNumberInput.value
                };
                localStorage.setItem('shoppingCartState', JSON.stringify(state));
            };

            const loadStateFromLocalStorage = () => {
                const savedStateJSON = localStorage.getItem('shoppingCartState');
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    cart = savedState.cart || [];
                    globalDiscount = savedState.globalDiscount || 0;
                    clientNameInput.value = savedState.clientName || '';
                    whatsappNumberInput.value = savedState.whatsappNumber || '';
                    discountInput.value = globalDiscount || '';
                    renderCart();
                }
            };
            
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const showMessage = (text) => {
                messageBox.textContent = text;
                messageBox.classList.remove('opacity-0');
                setTimeout(() => { messageBox.classList.add('opacity-0'); }, 3000);
            };
            
            const parseCSV = (csvText) => {
                const lines = csvText.trim().replace(/\r/g, '').split('\n');
                const products = [];
                let currentBlock = [];
                const startRegex = /^"?\d+\s*-\s*/;
                const priceRegex = /,"(\d+,\d+)"$|,""(\d+,\d+)"""?$/;
                const junkLineRegex = /Pág:|Usuário CLAUDIO|Descricao,,Ncm,No.|LOURENCO E SILVA|CNPJ :/

                const processBlock = (block) => {
                    if (block.length === 0) return;
                    const fullText = block.join(' ');
                    const priceMatch = fullText.match(priceRegex);
                    if (!priceMatch) return;
                    const priceStr = priceMatch[1] || priceMatch[2];
                    const price = parseFloat(priceStr.replace(',', '.'));
                    const idMatch = block[0].match(/^"?(\d+)/);
                    if(!idMatch) return;
                    const id = idMatch[1];
                    let manufacturer = 'N/A';
                    const manuParts = fullText.split(/,|\s/);
                    for(let i = manuParts.length - 1; i >= 0; i--) {
                        let part = manuParts[i].replace(/"/g, '').trim();
                        if(part.length > 2 && isNaN(part) && part === part.toUpperCase()) {
                            manufacturer = part;
                            break;
                        }
                    }
                    let description = block.map(line => line.replace(priceRegex, '').replace(/"/g, '').replace(/,/g, ' ').replace(/\s\s+/g, ' ').trim()).join(' ').trim();
                    description = description.replace(/^\d+\s*-\s*/, '');
                    if (manufacturer !== 'N/A') {
                       const manuIndex = description.toUpperCase().lastIndexOf(manufacturer);
                       if (manuIndex > -1) {
                         description = description.substring(0, manuIndex).trim();
                       }
                    }
                    const uuid = 'prod-' + (products.length + 1);
                    if (id && description && !isNaN(price) && description.length > 0) {
                        products.push({ id, uuid, description, manufacturer, price, originalPrice: price });
                    }
                };

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || junkLineRegex.test(trimmed) || trimmed.split(',').every(c => c === '""' || c === '')) continue;
                    if (startRegex.test(trimmed)) {
                        processBlock(currentBlock);
                        currentBlock = [trimmed];
                    } else if (currentBlock.length > 0) {
                        currentBlock.push(trimmed);
                    }
                }
                processBlock(currentBlock);
                return products;
            };

            const loadProducts = async () => {
                showMessage("Carregando produtos...");
                try {
                    const response = await fetch('produtos.csv?t=' + Date.now());
                    if (!response.ok) throw new Error(`Arquivo 'produtos.csv' não encontrado.`);
                    const csvText = await response.text();
                    if (!csvText) throw new Error("O arquivo 'produtos.csv' está vazio.");
                    allProducts = parseCSV(csvText);
                    showMessage(`${allProducts.length} produtos carregados!`);
                } catch (err) {
                    showMessage(err.message);
                }
            };
            
            const renderProducts = (products) => {
                productListElement.innerHTML = '';
                const initialMsg = document.getElementById('initial-message');
                if (products.length > 0) {
                    if(initialMsg) initialMsg.style.display = 'none';
                    products.forEach(product => {
                        const item = document.createElement('div');
                        item.className = 'bg-white p-3 rounded-md flex justify-between items-center shadow';
                        item.innerHTML = `
                            <div>
                                <p class="font-semibold text-sm text-gray-800">${product.description}</p>
                                <p class="text-xs text-gray-500">${product.manufacturer}</p>
                                <p class="text-green-600 font-bold mt-1">${formatCurrency(product.price)}</p>
                            </div>
                            <button class="add-btn w-10 h-10 bg-green-500 text-white rounded-full text-2xl font-light flex items-center justify-center hover:bg-green-600 transition-colors" data-uuid="${product.uuid}">+</button>
                        `;
                        productListElement.appendChild(item);
                    });
                } else {
                    if(initialMsg) initialMsg.style.display = 'block';
                    if (searchInput.value.length >= 3) {
                         if(initialMsg) initialMsg.textContent = 'Nenhum produto encontrado.';
                    } else {
                         if(initialMsg) initialMsg.textContent = 'Digite para buscar...';
                    }
                }
            };
            
            const renderCart = () => {
                cartItemsElement.innerHTML = '';
                let subtotal = 0;
                if (cart.length === 0) {
                    cartItemsElement.innerHTML = '<p class="text-gray-500">Seu pedido está vazio.</p>';
                } else {
                    cart.forEach((item, index) => {
                        const itemSubtotal = item.quantity * item.price;
                        subtotal += itemSubtotal;
                        const li = document.createElement('li');
                        li.className = 'bg-white p-2 rounded-md flex justify-between items-center shadow-sm cursor-pointer';
                        li.dataset.index = index;
                        li.innerHTML = `
                            <div>
                                <p class="font-semibold text-sm pointer-events-none">${item.description}</p>
                                <p class="text-xs text-gray-600 pointer-events-none">Qtd: ${item.quantity} | Total: ${formatCurrency(itemSubtotal)}</p>
                            </div>
                            <button class="remove-btn w-8 h-8 bg-red-500 text-white rounded-full text-lg flex items-center justify-center hover:bg-red-600 transition-colors" data-index="${index}">×</button>
                        `;
                        cartItemsElement.appendChild(li);
                    });
                }
                const total = subtotal - globalDiscount;
                totalValueElement.textContent = formatCurrency(total > 0 ? total : 0);
                saveStateToLocalStorage(); // Salva o estado sempre que o carrinho é renderizado
            };

            const updateModalTotal = () => {
                const qty = parseInt(modalQtyInput.value) || 1;
                const price = parseFloat(modalItemPrice.value) || 0;
                const discountPercent = parseFloat(modalItemDiscount.value) || 0;
                const finalPricePerItem = price * (1 - (discountPercent / 100));
                modalTotalPrice.textContent = formatCurrency(qty * finalPricePerItem);
            };
            
            const openModal = (product, editIndex = null) => {
                currentModalProduct = product;
                currentEditIndex = editIndex;
                modalItemName.textContent = product.description.substring(0, 25) + '...';
                modalItemManufacturer.textContent = product.manufacturer;
                modalQtyInput.value = product.quantity || '1';
                modalItemPrice.value = (product.price || product.originalPrice).toFixed(2);
                modalItemDiscount.value = product.discountPercent || '';
                modalAddBtn.textContent = (editIndex !== null) ? 'ATUALIZAR' : 'ADICIONAR';
                updateModalTotal();
                modal.classList.remove('hidden');
            };

            const closeModal = () => modal.classList.add('hidden');
            
            const handleModalSubmit = () => {
                if (!currentModalProduct) return;
                const qty = parseInt(modalQtyInput.value) || 1;
                const price = parseFloat(modalItemPrice.value);
                const discountPercent = parseFloat(modalItemDiscount.value) || 0;
                const finalPricePerItem = price * (1 - (discountPercent / 100));

                if (currentEditIndex !== null) {
                    const itemToUpdate = cart[currentEditIndex];
                    itemToUpdate.quantity = qty;
                    itemToUpdate.price = finalPricePerItem;
                    itemToUpdate.discountPercent = discountPercent;
                } else {
                    const existingItem = cart.find(item => item.uuid === currentModalProduct.uuid && item.price === finalPricePerItem);
                    if (existingItem) {
                        existingItem.quantity += qty;
                    } else {
                        cart.push({ ...currentModalProduct, quantity: qty, price: finalPricePerItem, discountPercent: discountPercent });
                    }
                }
                renderCart();
                closeModal();
            };

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (searchTerm.length < 3) {
                    renderProducts([]);
                    return;
                }
                const searchWords = searchTerm.split(/\s+/).filter(Boolean);
                if (searchWords.length === 0) {
                    renderProducts([]);
                    return;
                }
                const filteredProducts = allProducts.filter(product => {
                    const productDesc = product.description.toLowerCase();
                    return searchWords.every(word => productDesc.includes(word));
                });
                renderProducts(filteredProducts);
            });

            // --- Lógica da Busca por Voz ---
            voiceSearchBtn.addEventListener('click', () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    showMessage("Seu navegador não suporta a busca por voz.");
                    return;
                }

                const recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.start();

                voiceSearchBtn.classList.add('animate-pulse', 'bg-red-500');
                voiceSearchBtn.classList.remove('bg-green-500');
                showMessage("Ouvindo...");

                recognition.onresult = (event) => {
                    const speechResult = event.results[0][0].transcript;
                    searchInput.value = speechResult;
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                };

                recognition.onspeechend = () => {
                    recognition.stop();
                    voiceSearchBtn.classList.remove('animate-pulse', 'bg-red-500');
                    voiceSearchBtn.classList.add('bg-green-500');
                };

                recognition.onerror = (event) => {
                    voiceSearchBtn.classList.remove('animate-pulse', 'bg-red-500');
                    voiceSearchBtn.classList.add('bg-green-500');
                    if (event.error == 'no-speech') {
                        showMessage("Nenhuma fala detectada. Tente novamente.");
                    } else if (event.error == 'audio-capture') {
                        showMessage("Problema na captura de áudio.");
                    } else if (event.error == 'not-allowed') {
                        showMessage("Permissão para usar o microfone negada.");
                    } else {
                        showMessage("Erro no reconhecimento de voz: " + event.error);
                    }
                };
            });
            // --- Fim da Lógica da Busca por Voz ---

            productListElement.addEventListener('click', (e) => {
                const btn = e.target.closest('.add-btn');
                if (btn) {
                    const product = allProducts.find(p => p.uuid === btn.dataset.uuid);
                    if (product) openModal(product);
                }
            });
            
            cartItemsElement.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-btn');
                if (removeBtn) {
                    cart.splice(removeBtn.dataset.index, 1);
                    renderCart();
                    return; 
                }
                const itemLi = e.target.closest('li');
                if (itemLi) {
                    const index = parseInt(itemLi.dataset.index, 10);
                    if (!isNaN(index) && cart[index]) {
                        openModal(cart[index], index);
                    }
                }
            });
            
            clearCartBtn.addEventListener('click', () => {
                if (cart.length > 0 || globalDiscount > 0 || clientNameInput.value || whatsappNumberInput.value) {
                    cart = [];
                    discountInput.value = '';
                    globalDiscount = 0;
                    clientNameInput.value = '';
                    whatsappNumberInput.value = '';
                    renderCart(); // This will also save the empty state
                    showMessage('Pedido limpo com sucesso.');
                }
            });

            modalQtyPlus.addEventListener('click', () => { modalQtyInput.value = parseInt(modalQtyInput.value || 0) + 1; updateModalTotal(); });
            modalQtyMinus.addEventListener('click', () => { let qty = parseInt(modalQtyInput.value || 0); if (qty > 1) { modalQtyInput.value = qty - 1; updateModalTotal(); }});
            modalQtyInput.addEventListener('input', updateModalTotal);
            modalItemPrice.addEventListener('input', updateModalTotal);
            modalItemDiscount.addEventListener('input', updateModalTotal);
            modalAddBtn.addEventListener('click', handleModalSubmit);
            modalCancelBtn.addEventListener('click', closeModal);
            discountInput.addEventListener('input', () => { globalDiscount = parseFloat(discountInput.value) || 0; renderCart(); });
            
            // Salva o nome do cliente e número ao digitar
            clientNameInput.addEventListener('input', saveStateToLocalStorage);
            whatsappNumberInput.addEventListener('input', saveStateToLocalStorage);

            const generateQuoteText = () => {
                if (cart.length === 0) { showMessage("O pedido está vazio."); return null; }
                
                const clientName = clientNameInput.value.trim();
                let subtotal = 0;
                let text = `*Orçamento*\n`;
                if(clientName) {
                    text += `*Cliente:* ${clientName}\n`;
                }
                text += `\n`;

                cart.forEach(item => {
                    const itemTotal = item.quantity * item.price;
                    subtotal += itemTotal;
                    text += `*${item.description}*\n`;
                    text += `_Fabricante: ${item.manufacturer}_\n`;
                    text += `_Qtd: ${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(itemTotal)}_\n\n`;
                });
                const total = subtotal - globalDiscount;
                text += `*Subtotal:* ${formatCurrency(subtotal)}\n`;
                if(globalDiscount > 0) text += `*Desconto:* -${formatCurrency(globalDiscount)}\n`;
                text += `*Total:* *${formatCurrency(total > 0 ? total : 0)}*`;
                return text;
            };

            const generatePDF = () => {
                if (cart.length === 0) {
                    showMessage("O pedido está vazio.");
                    return;
                }
                const clientName = clientNameInput.value.trim();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const now = new Date();
                const dateStr = now.toLocaleDateString('pt-BR');
                const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                let y = 15;
                const lineHeight = 7;
                const margin = 15;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // --- PDF Header ---
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("LOURENCO E SILVA", margin, y);

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text("Rua Exemplo, 123 - Centro", margin, y + 5);
                doc.text("Telefone: (99) 99999-9999", margin, y + 10);

                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Orçamento", pageWidth - margin, y, { align: 'right' });

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Data: ${dateStr} ${timeStr}`, pageWidth - margin, y + 5, { align: 'right' });
                y += 20;

                doc.line(margin, y, pageWidth - margin, y); // Separator line
                y += 10;
                
                if(clientName){
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Cliente: ${clientName}`, margin, y);
                    y += lineHeight * 2;
                }

                let subtotal = 0;
                cart.forEach(item => {
                    if (y > pageHeight - 40) { // check for footer space
                        doc.addPage();
                        y = 15;
                    }
                    const itemTotal = item.quantity * item.price;
                    subtotal += itemTotal;
                    const splitDescription = doc.splitTextToSize(item.description, pageWidth - margin * 2);
                    
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(splitDescription, margin, y);
                    y += (splitDescription.length * (lineHeight-2));

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Fabricante: ${item.manufacturer}`, margin, y);
                    y += lineHeight;
                    doc.text(`Qtd: ${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(itemTotal)}`, margin, y);
                    y += lineHeight * 1.5; 
                });

                y += lineHeight;
                doc.line(margin, y, pageWidth - margin, y);
                y += lineHeight;

                const total = subtotal - globalDiscount;

                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text(`Subtotal:`, margin, y);
                doc.text(`${formatCurrency(subtotal)}`, pageWidth - margin, y, { align: 'right' });
                y += lineHeight;

                if (globalDiscount > 0) {
                    doc.setFont("helvetica", "normal");
                    doc.text(`Desconto:`, margin, y);
                    doc.text(`-${formatCurrency(globalDiscount)}`, pageWidth - margin, y, { align: 'right' });
                    y += lineHeight;
                }
                
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(`Total:`, margin, y);
                doc.text(`${formatCurrency(total > 0 ? total : 0)}`, pageWidth - margin, y, { align: 'right' });

                // --- PDF Footer ---
                doc.setFontSize(8);
                doc.setFont("helvetica", "italic");
                doc.text("Este orçamento é válido por 7 dias.", margin, pageHeight - 10);

                const fileName = clientName ? `orcamento-${clientName.replace(/\s+/g, "_")}.pdf` : 'orcamento.pdf';
                doc.save(fileName);
                showMessage("PDF gerado com sucesso!");
            };

            whatsappBtn.addEventListener('click', () => {
                const text = generateQuoteText();
                if (!text) return;
                let phone = whatsappNumberInput.value.replace(/\D/g, '');
                if (!phone) { showMessage("Digite o número do cliente."); return; }
                if (!phone.startsWith('55')) phone = '55' + phone;
                window.open(`https.wa.me/${phone}?text=${encodeURIComponent(text)}`);
            });

            copyBtn.addEventListener('click', () => {
                const text = generateQuoteText();
                if (!text) return;
                const quoteTextArea = document.getElementById('quote-text');
                quoteTextArea.value = text;
                quoteTextArea.select();
                try {
                   document.execCommand('copy');
                   showMessage("Orçamento copiado!");
                } catch (err) {
                   showMessage("Erro ao copiar.");
                }
            });
            
            pdfBtn.addEventListener('click', generatePDF);

            const checkPassword = () => {
                if (passwordInput.value === '777') {
                    passwordModal.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    loadProducts(); 
                    loadStateFromLocalStorage(); // Carrega o estado do carrinho
                } else {
                    passwordError.textContent = 'Senha incorreta.';
                    passwordInput.value = '';
                    passwordInput.focus();
                    setTimeout(() => passwordError.textContent = '', 2000);
                }
            };
            passwordSubmit.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    checkPassword();
                }
            });
        });
    </script>
</body>
</html>
