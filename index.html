<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vendas</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        header {
            grid-column: 1 / -1;
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary-color);
        }
        header h1 { margin: 0; color: var(--primary-color); }
        #company-info { font-size: 0.9em; color: var(--secondary-color); }
        main { display: flex; flex-direction: column; }
        .search-container { margin-bottom: 20px; }
        #search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }
        aside { position: sticky; top: 20px; height: fit-content; }
        #product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            min-height: 100px;
        }
        #initial-message {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--secondary-color);
            padding: 40px 20px;
            background-color: var(--surface-color);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }
        .product-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .product-description { font-weight: bold; margin-bottom: 10px; flex-grow: 1; font-size: 0.9em; }
        .product-price { font-size: 1.2em; color: var(--success-color); margin-bottom: 15px; }
        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
        }
        #cart {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #cart h2 { margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        #cart-items { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .cart-item {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }
        .cart-item-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .cart-item-details { flex-grow: 1; margin-right: 10px; }
        .cart-item-controls { display: flex; align-items: center; white-space: nowrap; }
        .cart-item-price-editor { display: flex; align-items: center; justify-content: flex-end; gap: 5px;}
        .cart-item-price-editor label { font-size: 0.8em; }
        .cart-item-price {
            width: 80px;
            text-align: right;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px;
        }
        .quantity-btn, .remove-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin: 0 5px;
        }
        .remove-btn { color: var(--danger-color); border-color: var(--danger-color); font-weight: bold;}
        .totals-section { margin-top: 15px; }
        .discount-row, .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 1.1em;
        }
        #discount-input {
            width: 100px;
            text-align: right;
            font-size: 0.9em;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        #cart-total { font-size: 1.5em; font-weight: bold; }
        .whatsapp-section { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        #whatsapp-number { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; box-sizing: border-box; margin-bottom: 10px; }
        .action-btn { color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; font-size: 0.95em; box-sizing: border-box; }
        .action-btn.whatsapp { background-color: #25D366; }
        .action-btn.copy { background-color: var(--secondary-color); }
        #loading, #error { grid-column: 1 / -1; }
        #error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 8px; display: none; word-wrap: break-word; padding: 20px;}
        #message-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #message-box.show { opacity: 1; visibility: visible; }
        
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            aside { position: static; margin-top: 30px; }
            .product-card { flex-direction: row; justify-content: space-between; align-items: center; }
            .product-card > div:last-child { min-width: 100px; text-align: right; }
            .add-to-cart-btn { width: auto; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Sistema de Vendas</h1>
            <div id="company-info">Carregando...</div>
        </header>

        <main>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Digite 3 letras para buscar...">
            </div>
            <div id="product-list">
                <div id="initial-message">
                    <p>A lista de produtos aparecerá aqui assim que você começar a digitar.</p>
                </div>
            </div>
            <div id="loading" style="display: none;">Carregando produtos...</div>
            <div id="error"></div>
        </main>

        <aside>
            <div id="cart">
                <h2>Carrinho</h2>
                <ul id="cart-items"></ul>
                <div class="totals-section">
                    <div class="discount-row">
                        <label for="discount-input">Desconto (R$):</label>
                        <input type="number" id="discount-input" placeholder="0,00" step="0.01">
                    </div>
                    <div id="cart-total" class="total-row">
                        <span>Total:</span>
                        <strong>R$ 0,00</strong>
                    </div>
                </div>
                <div class="whatsapp-section">
                    <input type="tel" id="whatsapp-number" placeholder="DDD + Número do cliente">
                    <button id="whatsapp-btn" class="action-btn whatsapp">Enviar Orçamento</button>
                    <button id="copy-btn" class="action-btn copy">Copiar Orçamento</button>
                </div>
            </div>
        </aside>
    </div>

    <textarea id="quote-text" style="position: absolute; left: -9999px;"></textarea>
    <div id="message-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productListElement = document.getElementById('product-list');
            const cartItemsElement = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total').querySelector('strong');
            const companyInfoElement = document.getElementById('company-info');
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const searchInputElement = document.getElementById('search-input');
            const initialMessage = document.getElementById('initial-message');
            const whatsappBtn = document.getElementById('whatsapp-btn');
            const copyBtn = document.getElementById('copy-btn');
            const whatsappNumberInput = document.getElementById('whatsapp-number');
            const quoteTextarea = document.getElementById('quote-text');
            const messageBox = document.getElementById('message-box');
            const discountInput = document.getElementById('discount-input');

            let cart = [];
            let allProducts = [];
            let discount = 0;

            const showMessage = (text, duration = 3000) => {
                messageBox.textContent = text;
                messageBox.classList.add('show');
                setTimeout(() => { messageBox.classList.remove('show'); }, duration);
            };
            const showError = (message) => {
                loadingElement.style.display = 'none';
                productListElement.innerHTML = '';
                errorElement.innerHTML = `<strong>Ocorreu um erro:</strong><br>${message}`;
                errorElement.style.display = 'block';
            };

            // --- VERSÃO FINAL E ROBUSTA DA FUNÇÃO DE LEITURA ---
            const parseCSV = (csvText) => {
                try {
                    const lines = csvText.trim().replace(/\r/g, '').split('\n');
                    const products = [];

                    // Extrai informações da empresa de forma segura
                    const companyNameLine = lines.find(line => line.includes('LOURENCO E SILVA'));
                    const companyName = companyNameLine ? companyNameLine.split(',').map(s => s.replace(/"/g, '').trim()).filter(s => s.includes('LOURENCO E SILVA'))[0] || 'Nome da Empresa' : 'Nome da Empresa';
                    const cnpjLine = lines.find(line => line.includes('CNPJ'));
                    const cnpj = cnpjLine ? cnpjLine.split('IE')[0].replace(/"/g, '').replace(/,/g, ' ').replace('CNPJ :', '').trim() : 'CNPJ não encontrado';
                    companyInfoElement.innerText = `${companyName} - CNPJ: ${cnpj}`;

                    // Expressões Regulares para identificar o preço no final de uma linha
                    const priceRegex1 = /,"(\d+,\d+)"$/; // Ex: ,"18,37"
                    const priceRegex2 = /,""(\d+,\d+)"""?$/; // Ex: ,""80,89"""

                    let currentProductBlock = [];

                    for (const line of lines) {
                        // Ignora linhas de cabeçalho/rodapé e linhas vazias
                        if (!line || line.trim() === '' || line.includes('Pág:') || line.includes('Usuário CLAUDIO') || line.includes('Descricao,,Ncm,No.')) {
                            continue;
                        }

                        // Verifica se a linha contém um preço em um dos formatos esperados
                        const hasPrice = priceRegex1.test(line) || priceRegex2.test(line);

                        if (hasPrice) {
                            // Se o bloco anterior não era vazio, processa-o.
                            if (currentProductBlock.length > 0) {
                                processProductBlock(currentProductBlock, products);
                            }
                            // Inicia um novo bloco com a linha atual que contém o preço.
                            currentProductBlock = [line];
                        } else {
                            // Se não tem preço, é uma linha de continuação da descrição.
                            if (currentProductBlock.length > 0) {
                                currentProductBlock.push(line);
                            }
                        }
                    }
                    // Processa o último bloco que restou no final do arquivo
                    if (currentProductBlock.length > 0) {
                        processProductBlock(currentProductBlock, products);
                    }

                    if (products.length === 0) { throw new Error("Nenhum produto foi encontrado. Verifique o formato do arquivo CSV."); }
                    return products;

                } catch (err) {
                    throw new Error(`Erro ao analisar o CSV: ${err.message}`);
                }
            };

            const processProductBlock = (block, products) => {
                const fullText = block.join(' ');
                const priceMatch = fullText.match(/,"(\d+,\d+)"$/) || fullText.match(/,""(\d+,\d+)"""?$/);
                
                if (priceMatch) {
                    const price = parseFloat(priceMatch[1].replace(',', '.'));
                    
                    let description = block.map(line =>
                        line.replace(/,""?[^"]+""?\s*$/, '') // Remove a parte do preço/final
                            .replace(/"/g, '')
                            .replace(/,/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim()
                    ).join(' ').trim();

                    const idMatch = description.match(/^\d{5}/);
                    let id = null;
                    if (idMatch) {
                        id = idMatch[0];
                        description = description.substring(id.length).replace(/^-/, '').trim();
                    } else {
                        // Se não encontrar ID de 5 dígitos, usa um ID aleatório para evitar erros
                        id = 'prod_' + (Math.random() + 1).toString(36).substring(7);
                    }
                    
                    if (id && description && !isNaN(price)) {
                        products.push({ id, description, price, originalPrice: price });
                    }
                }
            };

            const loadProducts = async () => { /* ...código original... */ };
            const renderProducts = (products) => { /* ...código original... */ };
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const renderCart = () => { /* ...código original... */ };
            const updateCart = (itemIndex, change) => { /* ...código original... */ };
            const removeFromCart = (itemIndex) => { /* ...código original... */ };
            const updateItemPrice = (itemIndex, newPrice) => { /* ...código original... */ };
            function generateQuoteText() { /* ...código original... */ }
            
            // --- Funções coladas para garantir a completude ---
             loadProducts = async () => {
                loadingElement.style.display = 'block';
                try {
                    const response = await fetch('produtos.csv?t=' + new Date().getTime());
                    if (!response.ok) { throw new Error(`Arquivo 'produtos.csv' não encontrado. Status: ${response.status}`); }
                    const csvText = await response.text();
                    if (!csvText) { throw new Error("O arquivo 'produtos.csv' está vazio."); }
                    allProducts = parseCSV(csvText);
                } catch (err) { showError(err.message); }
                loadingElement.style.display = 'none';
            };
            renderProducts = (products) => {
                productListElement.innerHTML = '';
                initialMessage.style.display = 'none';
                if(products.length === 0 && searchInputElement.value.length >= 3) {
                     productListElement.innerHTML = '<p id="initial-message" style="grid-column: 1 / -1; text-align: center;">Nenhum produto encontrado.</p>';
                     return;
                }
                if (products.length > 0) {
                    products.forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.innerHTML = `<div class="product-description" title="${product.description}">${product.description}</div><div><div class="product-price">${formatCurrency(product.price)}</div><button class="add-to-cart-btn" data-id="${product.id}">Adicionar</button></div>`;
                        productListElement.appendChild(card);
                    });
                }
            };
             renderCart = () => {
                cartItemsElement.innerHTML = '';
                let subtotal = 0;
                if (cart.length === 0) {
                    cartItemsElement.innerHTML = '<li>Seu carrinho está vazio.</li>';
                } else {
                    cart.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'cart-item';
                        const itemSubtotal = item.quantity * item.price;
                        subtotal += itemSubtotal;
                        li.innerHTML = `
                            <div class="cart-item-info">
                                <div class="cart-item-details">
                                    <span>${item.description}</span><br>
                                    <small>${item.quantity} x ${formatCurrency(item.price)} = ${formatCurrency(itemSubtotal)}</small>
                                </div>
                                <div class="cart-item-controls">
                                    <button class="quantity-btn" data-index="${index}" data-change="-1">-</button>
                                    <span>${item.quantity}</span>
                                    <button class="quantity-btn" data-index="${index}" data-change="1">+</button>
                                    <button class="remove-btn" data-index="${index}">×</button>
                                </div>
                            </div>
                            <div class="cart-item-price-editor">
                                <label for="price-${index}">Preço Unit.:</label>
                                <input type="number" class="cart-item-price" id="price-${index}" data-index="${index}" value="${item.price.toFixed(2)}" step="0.01">
                            </div>
                        `;
                        cartItemsElement.appendChild(li);
                    });
                }
                const total = subtotal - discount;
                cartTotalElement.textContent = formatCurrency(total > 0 ? total : 0);
            };
            const addToCart = (productId) => {
                const product = allProducts.find(p => p.id === productId);
                if (!product) {
                    console.error("Produto não encontrado:", productId);
                    showMessage("Erro: Não foi possível adicionar o produto.");
                    return;
                }
                const cartItem = cart.find(item => item.id === productId && item.price === product.price);
                if (cartItem) {
                    cartItem.quantity++;
                } else {
                    cart.push({ ...product, quantity: 1, price: product.originalPrice }); // Garante que o preço seja o original ao adicionar
                }
                renderCart();
            };
            updateCart = (itemIndex, change) => {
                 const cartItem = cart[itemIndex];
                 if (cartItem) {
                     cartItem.quantity += change;
                     if(cartItem.quantity <= 0) { cart.splice(itemIndex, 1); }
                 }
                 renderCart();
            };
            removeFromCart = (itemIndex) => {
                cart.splice(itemIndex, 1);
                renderCart();
            };
            updateItemPrice = (itemIndex, newPrice) => {
                const cartItem = cart[itemIndex];
                if(cartItem && newPrice >= 0) { cartItem.price = newPrice; }
                renderCart();
            };
            generateQuoteText = () => {
                if (cart.length === 0) { return ""; }
                let subtotal = 0;
                let quote = `*Orçamento - ${companyInfoElement.innerText.trim()}*\n\n`;
                quote += "Olá! Segue o orçamento solicitado:\n\n";
                cart.forEach(item => {
                    const itemTotal = item.quantity * item.price;
                    subtotal += itemTotal;
                    quote += `*Item:* ${item.description}\n`;
                    quote += `*Qtd:* ${item.quantity} | *Valor Unit:* ${formatCurrency(item.price)} | *Subtotal:* ${formatCurrency(itemTotal)}\n\n`;
                });
                const total = subtotal - discount;
                quote += "--------------------\n";
                quote += `*Subtotal:* ${formatCurrency(subtotal)}\n`;
                if(discount > 0) { quote += `*Desconto:* -${formatCurrency(discount)}\n`; }
                quote += `*Total do Pedido: ${formatCurrency(total > 0 ? total : 0)}*`;
                return quote;
            }

            // --- Event Listeners ---
            searchInputElement.addEventListener('input', () => {
                const searchTerm = searchInputElement.value.toLowerCase();
                if (searchTerm.length >= 3) {
                    initialMessage.style.display = 'none';
                    const filteredProducts = allProducts.filter(p => p.description.toLowerCase().includes(searchTerm));
                    renderProducts(filteredProducts);
                } else {
                    renderProducts([]); 
                    initialMessage.style.display = 'block';
                }
            });
            cartItemsElement.addEventListener('click', (e) => { const t = e.target; const index = parseInt(t.dataset.index, 10); if (isNaN(index)) return; if (t.classList.contains('quantity-btn')) { updateCart(index, parseInt(t.dataset.change, 10)); } if (t.classList.contains('remove-btn')) { removeFromCart(index); } });
            cartItemsElement.addEventListener('change', (e) => { const t = e.target; if (t.classList.contains('cart-item-price')) { const index = parseInt(t.dataset.index, 10); const newPrice = parseFloat(t.value); if (!isNaN(index) && !isNaN(newPrice)) { updateItemPrice(index, newPrice); } } });
            discountInput.addEventListener('input', () => { const value = parseFloat(discountInput.value); discount = isNaN(value) || value < 0 ? 0 : value; renderCart(); });
            whatsappBtn.addEventListener('click', () => { const quote = generateQuoteText(); if (!quote) { showMessage("Seu carrinho está vazio."); return; } let phone = whatsappNumberInput.value.replace(/\D/g, ''); if (phone.length < 10) { showMessage("Digite um número de telefone válido com DDD."); whatsappNumberInput.focus(); return; } if (!phone.startsWith('55')) { phone = '55' + phone; } window.open(`https://wa.me/${phone}?text=${encodeURIComponent(quote)}`, '_blank'); });
            copyBtn.addEventListener('click', () => { const quote = generateQuoteText(); if (!quote) { showMessage("Seu carrinho está vazio."); return; } quoteTextarea.value = quote; quoteTextarea.select(); document.execCommand('copy'); showMessage("Orçamento copiado!"); });
            
            loadProducts();
            renderCart();
        });
    </script>
</body>
</html>


